
---
title: "Test Estimation of ANC-lvl Turnout"
output: html_document
---


```{r setup, results='hide', echo=FALSE}

knitr::opts_chunk$set(echo=FALSE, cache=TRUE)

```


```{r init, results='hide'}

library(tidyverse)
library(magrittr)

#path <- getwd()

reg.fixed <- read.csv(file="../cleaned_data/anc_turnout.csv", sep=",", header=TRUE)

reg.fixed.drop <- read.csv(file="../cleaned_data/anc_turnout_drop.csv", sep=",", header=TRUE)

reg.fixed.drop %<>% select(anc.full, year, turnout) %>%
                    rename(turnout.drop = turnout)

reg.fixed %<>% full_join(reg.fixed.drop, by=c("anc.full", "year"))
```

## Context

We would like to have voter turnout data at the ANC level as another variable to contextualize engagement in ANC elections, but we only have # registered voters at precinct-level, which doens't align nicely with ANCs (though for 2014 and later, we have # ballots cast at ANC-level, which we'll use to test).

## Merge together dropping and apportioning turnout estimates with election data

```{r merge}
cat("\nCheck turnout-turnout merge\n\n")
tmp <- reg.fixed %>% filter(is.na(turnout) | is.na(turnout.drop))
print(tmp)

# Do a final test of match with election ballot data!

election.data <- read.csv(file="../cleaned_data/election_history_R.csv", sep=",", header=TRUE)

election.data %<>% mutate(anc.full = paste(ward,anc,sep="")) %>%
                  group_by(anc.full, year) %>%
                  summarize(actual.ballots = sum(smd_ballots)) %>%
		  select(anc.full, year, actual.ballots)

ballot.check <- reg.fixed %>%
                  inner_join(election.data, by=c("anc.full", "year")) %>%
                  mutate(error = ballots - actual.ballots,
		      rel.error = error / actual.ballots)

# merge is good
print("Who's missing from the election data?")
merge.e <- anti_join(reg.fixed, election.data, by=c("anc.full", "year"))
print(merge.e)

print("Who's missing from the turnout data?")
merge.t <- anti_join(election.data, reg.fixed, by=c("anc.full", "year"))
print(merge.t)

```
OH the reason I was seeing a bunch of NAs below is cuz missing 2012 data! so it's not so bad. what we are missing is 4G (from election data, cuz it's 3G) and 2F 3B 3F from turnout data. weird!

don't forget to full_join the two turnouts!!


# Compare estimated ballots with post-2012 actual ballots

```{r check}
w = ggplot(ballot.check, aes(rel.error)) + geom_histogram(binwidth=.05) +
                labs(title="Distribution of Relative Error in Estimating Ballots")
show(w)
print("hmm. a number of obs off by more than 1000. sharks.")


print("How Bad is It????")
print("(fivenum of diff)")
print(fivenum(ballot.check$error))
print("(diff in fivenums)")
print(fivenum(ballot.check$ballots) - fivenum(ballot.check$actual.ballots))

```

## Make some plots

```{r plots}

# Make a Plot
x <- ggplot(ballot.check) +
            geom_point(aes(actual.ballots, ballots,
	                colour=factor(duplicitous))) +
	    labs(title="How well does our estimate correspond to recorded ballots?")
show(x)
# doesn't look so bad here, but outliers are notable

# which ones are off??
cat("\nWhich ANCs have significant relative error in est. ballots?\n\n")
print(filter(ballot.check, abs(rel.error)>.25))
# I could keep some stuff like duplicitous count in reg.fixed...
# 3G, 2F, 2A 2018 are real farcked
# they aren't super small
# nor overly duplicitous
# do they have widely varying population densities?

# tag error outliers
ballot.check %<>% mutate(outlier = abs(rel.error)>.25)

y <- ggplot(ballot.check) + geom_point(aes(ballots, turnout, colour=factor(outlier))) +
                labs(title="How does estimated turnout relate to estimated ballots?")
show(y)
# what to make of this?? some ANCs have very low turnout, but only when they have few... ballots... aha. IV should be registrations maybe?

z <- ggplot(ballot.check) + geom_point(aes(turnout, turnout.drop, colour=factor(outlier))) +
                labs(title="How close are our two measures of turnout?")
show(z)
# looks tight. perhaps three outliers...
ballot.check %<>% mutate(turnout.diff = turnout - turnout.drop)
ballot.check <- ballot.check[order(ballot.check$turnout.diff),] 
cat("\nWhich ANCs have the greatest discrepancy between turnout and turnout.drop?\n\n")
print(head(ballot.check))
# ********* Q: are these the same as outliers in plot above??

```





oh the joined dataset only has 50 obs. somebody's not matching nice

reg.fixed has all obs

collapsed election.data only has 50 obs...

Q: how many ancs are there??

- maybe 41 per reg.fixed

so the collapse is tossing most obs 2012-2018. why?

AUGH that thing where read.table fucks up! that's burned me before! use read.csv!!!

having fixed that, we get 160 obs in the joined up thing


wait but (with read.csv) the product of precinct_registration has 164...

ooooooh anc 4G is absent from election data?????

but I used election data to create reg.fixed too????

lol anc 3/4G is a ward-crossing ANC

which is formally coded as 3G?? hence absent 4G data?
